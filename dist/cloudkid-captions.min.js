!function(){function t(t){var i=t.lastIndexOf("."),n=parseInt(t.substr(i+1),10),e=t.substr(0,i).split(":"),s=36e5*parseInt(e[0],10),a=6e3*parseInt(e[1],10),r=1e3*parseInt(e[2],10);return s+a+r+n}var i=cloudkid.Audio,n=function(t,n){i||(i=cloudkid.Audio),this.isSlave=!!n,this.initialize(t)},e=n.prototype;e._captionDict=null,e._textField=null,e._completeCallback=null,e._lines=null,e._currentDuration=0,e._currentTime=0,e._currentLine=-1,e._lastActiveLine=-1,e._playing=!1;var s=null,a=!1;e.isSlave=!1,e.textIsProp=!0,e._animTimeline=null,e._isDestroyed=!1,e._boundUpdate=null,e._boundComplete=null,n.VERSION="1.0.2",n.init=function(t,i){s=new n(t,i)},Object.defineProperty(n,"instance",{get:function(){return s}}),e.initialize=function(t){if(this._lines=[],!(this.isSlave||i&&i.instance))throw"cloudkid.Audio must be loaded before captions are available";this.setDictionary(t),this._boundUpdate=this._updatePercent.bind(this),this._boundComplete=this._onSoundComplete.bind(this)},n.setMuteAll=function(t){a=t,s&&s._updateCaptions()},n.getMuteAll=function(){return a},e.setDictionary=function(i){if(i){this._captionDict=i;var n=/[0-9]+\:[0-9]{2}\:[0-9]{2}\.[0-9]{3}/;for(var e in i){var s=Array.isArray(i[e])?i[e]:i[e].lines;if(s)for(var a=0,r=s.length;r>a;++a){var l=s[a];"string"==typeof l.start&&(l.start=n.test(l.start)?t(l.start):parseInt(l.start,10)),"string"==typeof l.end&&(l.end=n.test(l.end)?t(l.end):parseInt(l.end,10))}else Debug.log("alias '"+e+"' has no lines!")}}},e.setTextField=function(t){this._textField&&(this.textIsProp?this._textField.text="":this._textField.setText("")),this._textField=t||null},e.hasCaption=function(t){return this._captionDict?!!this._captionDict[t]:!1},e._load=function(t){return this._isDestroyed?void 0:(this._reset(),t?void(this._lines=t.lines):void(this._lines=null))},e._reset=function(){this._currentLine=-1,this._lastActiveLine=-1},e.isPlaying=function(){return this._playing},e._calcCurrentDuration=function(){var t=this._lines;return t?t[t.length-1].end:0},Object.defineProperty(e,"currentDuration",{get:function(){return this._currentDuration}}),e.play=function(t,n){this._completeCallback=n,this._playing=!0,this._load(this._captionDict[t]),this.isSlave?this._currentDuration=this._calcCurrentDuration():(this._currentDuration=1e3*i.instance.getLength(t),i.instance.play(t,this._boundComplete,null,this._boundUpdate)),this.seek(0)},e.run=function(t){return this.stop(),this._load(this._captionDict[t]),this._currentDuration=this.isSlave?this._calcCurrentDuration():1e3*i.instance.getLength(t),this.seek(0),this._boundUpdate},e.runWithAnimation=function(t){t.soundAlias&&(this.stop(),this._animTimeline=t,this._load(this._captionDict[t.soundAlias]),cloudkid.OS.instance.addUpdateCallback("CK_Captions",this._updateToAnim.bind(this)))},e._onSoundComplete=function(){var t=this._completeCallback;this.stop(),t&&t()},e.stop=function(){!this.isSlave&&this._playing&&(i.instance.stop(),this._playing=!1),this._animTimeline&&(this._animTimeline=null,cloudkid.OS.instance.removeUpdateCallback("CK_Captions")),this._lines=null,this._completeCallback=null,this._reset(),this._updateCaptions()},e.seek=function(t){var i=this._currentTime=t,n=this._lines;if(!n)return void this._updateCaptions();if(i<n[0].start)return currentLine=this._lastActiveLine=-1,void this._updateCaptions();for(var e=n.length,s=0;e>s;s++){if(i>=n[s].start&&i<=n[s].end){this._currentLine=this._lastActiveLine=s,this._updateCaptions();break}i>n[s].end&&(this._lastActiveLine=s,this._currentLine=-1)}},e._updateToAnim=function(){!this._animTimeline||!this._animTimeline.playSound&&!this._animTimeline.soundInst||this._animTimeline.soundInst&&!this._animTimeline.soundInst.isValid?this.stop():this._animTimeline.soundInst&&this.seek(this._animTimeline.soundInst.position)},e._updatePercent=function(t){this._isDestroyed||(this._currentTime=t*this._currentDuration,this._calcUpdate())},e.updateTime=function(t){this._isDestroyed||(this._currentTime+=t,this._calcUpdate())},e._calcUpdate=function(){var t=this._lines;if(t){var i=t.length,n=this._lastActiveLine+1,e=i-1,s=this._currentTime;s>=t[e].end?(this._currentLine=-1,this._updateCaptions()):e>=n&&s>=t[n].start&&s<=t[n].end?(this._currentLine=this._lastActiveLine=n,this._updateCaptions()):-1!=this._currentLine&&s>t[this._currentLine].end&&(this._lastActiveLine=this._currentLine,this._currentLine=-1,this._updateCaptions())}},e._updateCaptions=function(){if(this._textField){var t=-1==this._currentLine||a?"":this._lines[this._currentLine].content;this.textIsProp?this._textField.text=t:this._textField.setText(t)}},e.destroy=function(){this._isDestroyed||(this._isDestroyed=!0,s===this&&(s=null),this._captionDict=null,this._lines=null)},namespace("cloudkid").Captions=n}();